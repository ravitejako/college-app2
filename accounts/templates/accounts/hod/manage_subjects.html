{% extends 'base.html' %}

{% block title %}Manage Subjects{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="container-fluid">
        <!-- Header Title and Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex flex-wrap justify-content-between align-items-center">
                    <h2 class="h5 font-weight-bold mb-2 mb-md-0">Department Subjects</h2>
                    <div>
                        <button class="btn btn-success mb-2 mb-md-0" data-bs-toggle="modal" data-bs-target="#addSubjectModal">
                            <i class="fas fa-plus me-1"></i> Add New Subject
                        </button>
                        <a href="{% url 'hod_dashboard' %}" class="btn btn-secondary ms-md-2">
                            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards Row -->
        <div class="row mb-4">
            <!-- Total Subjects Card -->
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card bg-primary text-white shadow-sm h-100">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-uppercase small mb-1 font-weight-bold">TOTAL SUBJECTS</div>
                                <div class="display-4 font-weight-bold">{{ subjects|length }}</div>
                            </div>
                            <div class="text-right opacity-75">
                                <i class="fas fa-book fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Assigned Subjects Card -->
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card bg-success text-white shadow-sm h-100">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-uppercase small mb-1 font-weight-bold">ASSIGNED SUBJECTS</div>
                                <div class="display-4 font-weight-bold">{{ assigned_count }}</div>
                            </div>
                            <div class="text-right opacity-75">
                                <i class="fas fa-user-check fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Unassigned Subjects Card -->
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card bg-warning text-white shadow-sm h-100">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-uppercase small mb-1 font-weight-bold">UNASSIGNED SUBJECTS</div>
                                <div class="display-4 font-weight-bold">{{ unassigned_count }}</div>
                            </div>
                            <div class="text-right opacity-75">
                                <i class="fas fa-user-times fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Members Card -->
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card bg-info text-white shadow-sm h-100">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-uppercase small mb-1 font-weight-bold">STAFF MEMBERS</div>
                                <div class="display-4 font-weight-bold">{{ staff_members|length }}</div>
                            </div>
                            <div class="text-right opacity-75">
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manage Staff Link -->
        <div class="row mb-3">
            <div class="col-12">
                <a href="{% url 'hod_manage_staff' %}" class="text-decoration-none">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-users text-primary me-2"></i>
                        <span class="text-muted">Manage Staff</span>
                    </div>
                </a>
            </div>
        </div>

        <!-- Manage Subjects Link - Active -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center">
                    <i class="fas fa-book text-primary me-2"></i>
                    <span class="text-dark">Manage Subjects</span>
                </div>
            </div>
        </div>
        
        <!-- Search & Filter Bar -->
        <div class="card bg-primary text-white mb-4 shadow-sm">
            <div class="card-body py-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-search me-2"></i>
                    <span>Search & Filter Subjects</span>
                </div>
            </div>
        </div>

        <!-- Search Form -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body p-3">
                <div class="row g-3">
                    <div class="col-md-6 col-lg-4 mb-2">
                        <label class="form-label small text-muted">Search Subjects</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control border-0 bg-light" id="searchInput" placeholder="Search by code or name...">
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2">
                        <label class="form-label small text-muted">Filter by Semester</label>
                        <select class="form-select bg-light border-0" id="semesterFilter">
                            <option value="">All Semesters</option>
                            {% for i in "12345678" %}
                            <option value="{{ i }}">Semester {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2">
                        <label class="form-label small text-muted">Filter by Staff Status</label>
                        <select class="form-select bg-light border-0" id="staffFilter">
                            <option value="">All Subjects</option>
                            <option value="assigned">Assigned</option>
                            <option value="unassigned">Unassigned</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-2 mb-2 d-flex align-items-end">
                        <button id="resetFilters" class="btn btn-secondary w-100">
                            <i class="fas fa-sync-alt me-1"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Data Table -->
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="d-flex justify-content-between p-3 border-bottom">
                    <h5 class="card-title mb-0">Subject List</h5>
                    <div class="d-flex align-items-center">
                        <span class="text-muted small me-3">{{ subjects|length }} Subjects</span>
                        <button id="exportExcelBtn" class="btn btn-sm btn-outline-success me-2">
                            <i class="fas fa-file-excel me-1"></i> Export
                        </button>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#bulkAssignStaffModal">
                            <i class="fas fa-user-plus me-1"></i> Bulk Assign
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover table-borderless mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th width="3%" class="p-2">#</th>
                                <th width="10%" class="p-2 sortable" data-sort="code">Code <i class="fas fa-sort ms-1"></i></th>
                                <th width="22%" class="p-2 sortable" data-sort="name">Name <i class="fas fa-sort ms-1"></i></th>
                                <th width="10%" class="p-2 sortable" data-sort="semester">Semester <i class="fas fa-sort ms-1"></i></th>
                                <th width="10%" class="p-2 sortable" data-sort="credits">Credits <i class="fas fa-sort ms-1"></i></th>
                                <th width="25%" class="p-2">Assigned Staff</th>
                                <th width="15%" class="p-2" style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subject in subjects %}
                            <tr class="subject-row" data-description="{{ subject.description|default:'' }}">
                                <td class="p-2">{{ forloop.counter }}</td>
                                <td class="p-2">{{ subject.code }}</td>
                                <td class="p-2">{{ subject.name }}</td>
                                <td class="p-2">{{ subject.semester }}</td>
                                <td class="p-2">{{ subject.credits }}</td>
                                <td class="p-2">
                                    {% if subject.staff %}
                                    <div class="d-flex align-items-center">
                                        {% if subject.staff.profile_picture %}
                                        <img src="{{ subject.staff.profile_picture.url }}" alt="Staff" class="rounded-circle me-2" width="32" height="32">
                                        {% else %}
                                        <div class="bg-primary rounded-circle text-white d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <div class="fw-medium">{{ subject.staff.get_full_name }}</div>
                                            <div class="small text-muted">{{ subject.staff.email }}</div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">Not Assigned</span>
                                    {% endif %}
                                </td>
                                <td class="p-2" style="text-align: right;">
                                    <div class="action-buttons-container">
                                        <a href="{% url 'hod_view_subject_details' subject.id %}" class="btn text-white" style="background-color: #00BCD4; width: 36px; height: 36px; padding: 6px; border-radius: 0;">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="#" data-bs-toggle="modal" data-bs-target="#assignStaffModal{{ subject.id }}" class="btn text-white" style="background-color: #2196F3; width: 36px; height: 36px; padding: 6px; border-radius: 0;">
                                            <i class="fas fa-user-plus"></i>
                                        </a>
                                        <a href="#" class="btn text-white edit-subject-btn" data-id="{{ subject.id }}" style="background-color: #FFC107; width: 36px; height: 36px; padding: 6px; border-radius: 0;">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="#" class="btn text-white delete-subject-btn" data-id="{{ subject.id }}" data-name="{{ subject.name }}" style="background-color: #F44336; width: 36px; height: 36px; padding: 6px; border-radius: 0;">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            
                            <!-- Modal for assigning staff -->
                            <div class="modal fade" id="assignStaffModal{{ subject.id }}" tabindex="-1" aria-labelledby="assignStaffModalLabel{{ subject.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header bg-primary text-white">
                                            <h5 class="modal-title" id="assignStaffModalLabel{{ subject.id }}">
                                                <i class="fas fa-user-plus me-2"></i>Assign Staff to {{ subject.name }}
                                            </h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form method="post">
                                            {% csrf_token %}
                                            <div class="modal-body">
                                                <input type="hidden" name="action" value="assign_staff">
                                                <input type="hidden" name="subject_id" value="{{ subject.id }}">
                                                
                                                <div class="alert alert-info">
                                                    <strong>Subject Details:</strong>
                                                    <ul class="mb-0 ps-3">
                                                        <li>Code: {{ subject.code }}</li>
                                                        <li>Name: {{ subject.name }}</li>
                                                        <li>Semester: {{ subject.semester }}</li>
                                                        <li>Credits: {{ subject.credits }}</li>
                                                    </ul>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="staffSearch{{ subject.id }}" class="form-label">Search Staff</label>
                                                    <input type="text" class="form-control staff-search" id="staffSearch{{ subject.id }}" placeholder="Type to search staff...">
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="staffSelect{{ subject.id }}" class="form-label">Select Staff</label>
                                                    <select class="form-select staff-select" id="staffSelect{{ subject.id }}" name="staff_id" required>
                                                        <option value="" disabled selected>Choose Staff</option>
                                                        {% for staff in staff_members %}
                                                        <option value="{{ staff.id }}" data-name="{{ staff.get_full_name|lower }}" data-id="{{ staff.staff_id|lower }}" {% if subject.staff == staff %}selected{% endif %}>
                                                            {{ staff.get_full_name }} ({{ staff.staff_id }})
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    <i class="fas fa-times me-1"></i>Cancel
                                                </button>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-user-plus me-1"></i>Assign Staff
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="noMatchesAlert" class="alert alert-warning m-3 d-none">
                    No subjects match your search criteria.
                </div>
            </div>
        </div>

        {% if subjects|length == 0 %}
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>No subjects added yet for this department.
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Subject Modal -->
<div class="modal fade" id="addSubjectModal" tabindex="-1" aria-labelledby="addSubjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addSubjectModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add New Subject
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_subject">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="code" class="form-label">Subject Code*</label>
                            <input type="text" class="form-control" id="code" name="code" required>
                            <div class="form-text">Enter a unique subject code (e.g., CS101, MATH201)</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Subject Name*</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="semester" class="form-label">Semester*</label>
                            <select class="form-select" id="semester" name="semester" required>
                                <option value="" disabled selected>Select Semester</option>
                                {% for i in "12345678" %}
                                <option value="{{ i }}">Semester {{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="credits" class="form-label">Credits*</label>
                            <select class="form-select" id="credits" name="credits" required>
                                <option value="" disabled selected>Select Credits</option>
                                {% for i in "12345" %}
                                <option value="{{ i }}">{{ i }} Credit{% if i != "1" %}s{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="staff" class="form-label">Assign Staff</label>
                        <select class="form-select" id="staff" name="staff">
                            <option value="">-- Select Staff (Optional) --</option>
                            {% for staff in staff_members %}
                            <option value="{{ staff.id }}">{{ staff.get_full_name }} ({{ staff.staff_id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="Enter a brief description of the subject..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Save Subject
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Subject Confirmation Modal -->
<div class="modal fade" id="deleteSubjectModal" tabindex="-1" aria-labelledby="deleteSubjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteSubjectModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the subject <strong id="deleteSubjectName"></strong>?</p>
                <p class="text-danger">This action cannot be undone. All data related to this subject will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <form method="post" id="deleteSubjectForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_subject">
                    <input type="hidden" name="subject_id" id="deleteSubjectId">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>Delete Subject
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Subject Modal -->
<div class="modal fade" id="editSubjectModal" tabindex="-1" aria-labelledby="editSubjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="editSubjectModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Subject
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="editSubjectForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="edit_subject">
                <input type="hidden" name="subject_id" id="editSubjectId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCode" class="form-label">Subject Code*</label>
                            <input type="text" class="form-control" id="editCode" name="code" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editName" class="form-label">Subject Name*</label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editSemester" class="form-label">Semester*</label>
                            <select class="form-select" id="editSemester" name="semester" required>
                                {% for i in "12345678" %}
                                <option value="{{ i }}">Semester {{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editCredits" class="form-label">Credits*</label>
                            <select class="form-select" id="editCredits" name="credits" required>
                                {% for i in "12345" %}
                                <option value="{{ i }}">{{ i }} Credit{% if i != "1" %}s{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3" placeholder="Enter a brief description of the subject..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-1"></i>Update Subject
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Assign Staff Modal -->
<div class="modal fade" id="bulkAssignModal" tabindex="-1" aria-labelledby="bulkAssignModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="bulkAssignModalLabel">
                    <i class="fas fa-users-cog me-2"></i>Bulk Assign Staff
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="bulkAssignForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="action" value="bulk_assign_staff">
                    <input type="hidden" name="subject_ids" id="bulkSubjectIds">
                    
                    <div class="alert alert-info">
                        <strong>Selected Subjects: <span id="selectedSubjectsCount">0</span></strong>
                        <div id="selectedSubjectsList" class="mt-2"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bulkStaffSelect" class="form-label">Select Staff to Assign</label>
                        <select class="form-select" id="bulkStaffSelect" name="staff_id" required>
                            <option value="" disabled selected>Choose Staff</option>
                            {% for staff in staff_members %}
                            <option value="{{ staff.id }}">{{ staff.get_full_name }} ({{ staff.staff_id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus me-1"></i>Assign Staff
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SheetJS library for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
{% endblock content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const semesterFilter = document.getElementById('semesterFilter');
        const staffFilter = document.getElementById('staffFilter');
        const resetFilters = document.getElementById('resetFilters');
        const subjectRows = document.querySelectorAll('.subject-row');
        const noMatchesAlert = document.getElementById('noMatchesAlert');
        const selectAllCheckbox = document.getElementById('selectAll');
        const subjectCheckboxes = document.querySelectorAll('.subject-select');
        const bulkAssignBtn = document.getElementById('bulkAssignBtn');
        
        // Search and filter
        function filterTable() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            const semesterValue = semesterFilter.value;
            const staffStatusValue = staffFilter.value;
            
            let visibleCount = 0;
            
            subjectRows.forEach(row => {
                const code = row.getAttribute('data-code');
                const name = row.getAttribute('data-name');
                const semester = row.getAttribute('data-semester');
                const staffStatus = row.getAttribute('data-staff-status');
                
                const matchesSearch = code.includes(searchTerm) || name.includes(searchTerm);
                const matchesSemester = !semesterValue || semester === semesterValue;
                const matchesStaffStatus = !staffStatusValue || staffStatus === staffStatusValue;
                
                const shouldDisplay = matchesSearch && matchesSemester && matchesStaffStatus;
                
                row.style.display = shouldDisplay ? '' : 'none';
                
                if (shouldDisplay) {
                    visibleCount++;
                }
            });
            
            noMatchesAlert.classList.toggle('d-none', visibleCount > 0);
        }
        
        searchInput.addEventListener('input', filterTable);
        semesterFilter.addEventListener('change', filterTable);
        staffFilter.addEventListener('change', filterTable);
        
        resetFilters.addEventListener('click', function() {
            searchInput.value = '';
            semesterFilter.value = '';
            staffFilter.value = '';
            filterTable();
        });
        
        // Sorting functionality
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-sort');
                sortTable(column, this);
            });
        });
        
        function sortTable(column, headerElement) {
            const table = document.getElementById('subjectsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Toggle sorting direction
            const currentDirection = headerElement.getAttribute('data-direction') || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            headerElement.setAttribute('data-direction', newDirection);
            
            // Update all headers
            document.querySelectorAll('.sortable').forEach(header => {
                if (header.getAttribute('data-sort') === column) {
                    header.querySelector('i').className = `fas fa-sort-${newDirection === 'asc' ? 'up' : 'down'} ms-1`;
                } else {
                    header.querySelector('i').className = 'fas fa-sort ms-1';
                    header.removeAttribute('data-direction');
                }
            });
            
            // Sort the rows
            rows.sort((a, b) => {
                let valueA, valueB;
                
                if (column === 'code' || column === 'name') {
                    valueA = a.getAttribute(`data-${column}`);
                    valueB = b.getAttribute(`data-${column}`);
                } else if (column === 'semester' || column === 'credits') {
                    valueA = parseInt(a.children[column === 'semester' ? 3 : 4].textContent);
                    valueB = parseInt(b.children[column === 'semester' ? 3 : 4].textContent);
                }
                
                if (newDirection === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
            
            // Re-append rows in new order
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // Staff search in modals
        document.querySelectorAll('.staff-search').forEach(searchInput => {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim().toLowerCase();
                const selectId = this.id.replace('Search', 'Select');
                const selectElement = document.getElementById(selectId);
                const options = selectElement.querySelectorAll('option');
                
                options.forEach(option => {
                    if (option.disabled) return;
                    
                    const name = option.getAttribute('data-name') || '';
                    const id = option.getAttribute('data-id') || '';
                    const matches = name.includes(searchTerm) || id.includes(searchTerm);
                    
                    option.style.display = matches ? '' : 'none';
                });
            });
        });
        
        // Delete subject functionality
        document.querySelectorAll('.delete-subject-btn').forEach(button => {
            button.addEventListener('click', function() {
                const subjectId = this.getAttribute('data-id');
                const subjectName = this.getAttribute('data-name');
                
                document.getElementById('deleteSubjectId').value = subjectId;
                document.getElementById('deleteSubjectName').textContent = subjectName;
                
                new bootstrap.Modal(document.getElementById('deleteSubjectModal')).show();
            });
        });
        
        // Select all functionality
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            
            subjectCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                if (row.style.display !== 'none') {
                    checkbox.checked = isChecked;
                }
            });
            
            updateBulkActions();
        });
        
        // Individual checkboxes
        subjectCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActions);
        });
        
        // Update bulk actions state
        function updateBulkActions() {
            const checkedBoxes = document.querySelectorAll('.subject-select:checked');
            bulkAssignBtn.disabled = checkedBoxes.length === 0;
            
            if (checkedBoxes.length > 0) {
                const subjectIds = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-id')).join(',');
                document.getElementById('bulkSubjectIds').value = subjectIds;
                document.getElementById('selectedSubjectsCount').textContent = checkedBoxes.length;
                
                // Create list of selected subjects
                const selectedSubjectsList = document.getElementById('selectedSubjectsList');
                selectedSubjectsList.innerHTML = '';
                
                Array.from(checkedBoxes).forEach(cb => {
                    const row = cb.closest('tr');
                    const code = row.querySelector('td:nth-child(2)').textContent;
                    const name = row.querySelector('td:nth-child(3)').textContent;
                    
                    const listItem = document.createElement('div');
                    listItem.classList.add('badge', 'bg-secondary', 'me-1', 'mb-1');
                    listItem.textContent = `${code}: ${name}`;
                    selectedSubjectsList.appendChild(listItem);
                });
            }
        }
        
        // Show bulk assign modal
        bulkAssignBtn.addEventListener('click', function() {
            new bootstrap.Modal(document.getElementById('bulkAssignModal')).show();
        });
        
        // Print functionality
        document.getElementById('printBtn').addEventListener('click', function() {
            window.print();
        });

        // Edit subject functionality
        document.querySelectorAll('.edit-subject-btn').forEach(button => {
            button.addEventListener('click', function() {
                const subjectId = this.getAttribute('data-id');
                const row = this.closest('tr');
                
                // Get values from the row
                const code = row.querySelector('td:nth-child(2)').textContent.trim();
                const name = row.querySelector('td:nth-child(3)').textContent.trim();
                const semester = row.querySelector('td:nth-child(4)').textContent.trim();
                const credits = row.querySelector('td:nth-child(5)').textContent.trim();
                const description = row.getAttribute('data-description') || '';
                
                // Set values in the edit form
                document.getElementById('editSubjectId').value = subjectId;
                document.getElementById('editCode').value = code;
                document.getElementById('editName').value = name;
                document.getElementById('editSemester').value = semester;
                document.getElementById('editCredits').value = credits;
                document.getElementById('editDescription').value = description;
                
                // Show the modal
                new bootstrap.Modal(document.getElementById('editSubjectModal')).show();
            });
        });

        // Excel export functionality
        document.getElementById('exportExcelBtn').addEventListener('click', function() {
            try {
                // Define Excel headers
                const headers = ['Code', 'Name', 'Semester', 'Credits', 'Assigned Staff'];
                
                // Get all visible rows
                const visibleRows = Array.from(document.querySelectorAll('.subject-row'))
                    .filter(row => row.style.display !== 'none');
                
                // Create data for Excel
                const data = [headers];
                visibleRows.forEach(row => {
                    const code = row.querySelector('td:nth-child(2)').textContent.trim();
                    const name = row.querySelector('td:nth-child(3)').textContent.trim();
                    const semester = row.querySelector('td:nth-child(4)').textContent.trim();
                    const credits = row.querySelector('td:nth-child(5)').textContent.trim();
                    
                    // Get staff name or "Not assigned"
                    let staffName = "Not assigned";
                    const staffElement = row.querySelector('td:nth-child(6)');
                    if (staffElement.querySelector('.d-flex')) {
                        staffName = staffElement.querySelector('div div').textContent.trim();
                    }
                    
                    data.push([code, name, semester, credits, staffName]);
                });
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Subjects');
                
                // Generate Excel file and trigger download
                XLSX.writeFile(wb, `Department_Subjects_${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('There was an error exporting to Excel. Please try again.');
            }
        });
    });
</script>
{% endblock extra_js %} 